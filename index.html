<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>WebGIS - GeoSpatialNusantara</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-omnivore/leaflet-omnivore.min.js"></script>

<style>
html, body { margin:0; height:100%; font-family:Segoe UI; }

#map {
    height:100%;
    width:75%;
    float:left;
}

#sidebar {
    width:25%;
    height:100%;
    float:left;
    overflow:auto;
    background:#ffffff;
    box-shadow:-3px 0 10px rgba(0,0,0,0.15);
    padding:15px;
}

h2 { margin-top:0; }

.category {
    font-weight:bold;
    margin-top:10px;
    padding:6px;
    background:#f1f1f1;
    border-radius:6px;
    cursor:pointer;
}

.year {
    margin-left:15px;
    margin-top:6px;
    display:flex;
    align-items:center;
    cursor:pointer;
}

.toggle {
    width:14px;
    height:14px;
    border-radius:50%;
    background:#ccc;
    margin-right:8px;
    transition:0.3s;
}

.toggle.active {
    background:#27ae60;
}
</style>
</head>

<body>

<div id="map"></div>

<div id="sidebar">
<h2>Layer Control</h2>
<div id="layerList"></div>
</div>

<script>

// ==========================
// KONFIGURASI GITHUB
// ==========================

const username = "GeoSpatialNusantara";
const repo = "WebGis";
const branch = "main";
const rootFolder = "file";

// ==========================
// INIT MAP
// ==========================

var map = L.map('map').setView([-2.5,118],5);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'© OpenStreetMap'
}).addTo(map);

let loadedLayers = {};

// ==========================
// FETCH RECURSIVE GITHUB
// ==========================

fetch(`https://api.github.com/repos/${username}/${repo}/git/trees/${branch}?recursive=1`)
.then(res => res.json())
.then(data => {

    let files = data.tree.filter(item =>
        item.path.startsWith(rootFolder + "/") &&
        (item.path.endsWith(".kml") ||
         item.path.endsWith(".kmz") ||
         item.path.endsWith(".zip"))
    );

    let structure = {};

    files.forEach(file => {
        let parts = file.path.split("/");
        let kategori = parts[1];
        let tahun = parts[2];

        if(!structure[kategori]) structure[kategori] = {};
        if(!structure[kategori][tahun]) structure[kategori][tahun] = [];

        structure[kategori][tahun].push(file);
    });

    buildSidebar(structure);
});

// ==========================
// BUILD SIDEBAR DINAMIS
// ==========================

function buildSidebar(structure){

    const container = document.getElementById("layerList");

    Object.keys(structure).forEach(kategori => {

        let catDiv = document.createElement("div");
        catDiv.className = "category";
        catDiv.innerHTML = "▼ " + kategori;

        let yearContainer = document.createElement("div");
        yearContainer.style.display = "none";

        catDiv.onclick = () => {
            yearContainer.style.display =
                yearContainer.style.display === "none" ? "block" : "none";
        };

        container.appendChild(catDiv);
        container.appendChild(yearContainer);

        Object.keys(structure[kategori]).forEach(tahun => {

            let yearDiv = document.createElement("div");
            yearDiv.className = "year";

            let toggle = document.createElement("span");
            toggle.className = "toggle";

            let label = document.createElement("span");
            label.innerText = tahun;

            yearDiv.appendChild(toggle);
            yearDiv.appendChild(label);
            yearContainer.appendChild(yearDiv);

            toggle.onclick = () => {

                if(toggle.classList.contains("active")){
                    toggle.classList.remove("active");
                    if(loadedLayers[kategori+tahun])
                        map.removeLayer(loadedLayers[kategori+tahun]);
                } 
                else {

                    toggle.classList.add("active");

                    let group = L.layerGroup();

                    structure[kategori][tahun].forEach(file => {

                        let rawUrl =
                        `https://raw.githubusercontent.com/${username}/${repo}/${branch}/${file.path}`;

                        let layer = omnivore.kml(rawUrl)
                        .on('ready', function(){
                            map.fitBounds(layer.getBounds());
                        });

                        layer.eachLayer(function(l){
                            let cleanName = file.path.split("/").pop()
                            .replace(".zip","")
                            .replace(".kml","")
                            .replace(".kmz","");
                            l.bindTooltip(cleanName);
                        });

                        layer.addTo(group);
                    });

                    group.addTo(map);
                    loadedLayers[kategori+tahun] = group;
                }
            };
        });
    });
}

</script>
</body>
</html>
