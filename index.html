<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>GSN WebGIS</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body { margin:0; font-family:Arial; }

#map { height:100vh; width:100%; }

/* ================= SIDEBAR DATA ================= */
#sidebar {
    position:absolute;
    left:0;
    top:0;
    width:320px;
    height:100%;
    background:#111;
    color:white;
    padding:15px;
    overflow:auto;
    transition:0.3s;
    z-index:1000;
}

#sidebar.collapsed {
    left:-320px;
}

.folder { margin-top:10px; }
.sub { margin-left:20px; margin-top:5px; }

button {
    background:none;
    border:none;
    color:white;
    font-weight:bold;
    cursor:pointer;
}

/* Tombol hamburger */
#toggleBtn {
    position:absolute;
    top:15px;
    left:15px;
    z-index:1100;
    background:white;
    border-radius:5px;
    padding:8px 10px;
    cursor:pointer;
    font-size:18px;
    box-shadow:0 2px 5px rgba(0,0,0,0.3);
}

/* ================= BASEMAP PANEL ================= */
#basemapPanel {
    position:absolute;
    right:15px;
    top:15px;
    background:white;
    padding:10px;
    border-radius:8px;
    box-shadow:0 2px 6px rgba(0,0,0,0.3);
    z-index:1100;
    font-size:14px;
}
</style>
</head>

<body>

<div id="toggleBtn">☰</div>

<div id="sidebar">
    <h3>DATA GSN</h3>
    <div id="folderList">Loading...</div>
</div>

<div id="basemapPanel">
    <b>Basemap</b><br>
    <input type="radio" name="basemap" value="osm" checked> OpenStreetMap<br>
    <input type="radio" name="basemap" value="sat"> Imagery
</div>

<div id="map"></div>

<script>
// ============================
// CONFIG REPO
// ============================
const username = "GeoSpatialNusantara";
const repo = "WebGis";
const rootFolder = "file";

const baseAPI = `https://api.github.com/repos/${username}/${repo}/contents/${rootFolder}`;

// ============================
// MAP INIT
// ============================
const map = L.map('map').setView([-2.5,118],5);

// Basemap layers
const osm = L.tileLayer(
    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    { attribution:'© OpenStreetMap' }
).addTo(map);

const imagery = L.tileLayer(
    'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png'
);

// Basemap switch
document.querySelectorAll('input[name="basemap"]').forEach(radio=>{
    radio.onchange = function(){
        if(this.value === "osm"){
            map.removeLayer(imagery);
            osm.addTo(map);
        } else {
            map.removeLayer(osm);
            imagery.addTo(map);
        }
    };
});

// ============================
// SIDEBAR COLLAPSE
// ============================
document.getElementById("toggleBtn").onclick = function(){
    document.getElementById("sidebar").classList.toggle("collapsed");
};

// ============================
// DATA LAYER
// ============================
const layers = {};

async function buildSidebar(){
    const container = document.getElementById("folderList");
    container.innerHTML = "";

    const res = await fetch(baseAPI);
    const folders = await res.json();

    folders.forEach(folder=>{
        if(folder.type !== "dir") return;

        const div = document.createElement("div");
        div.className = "folder";

        const btn = document.createElement("button");
        btn.textContent = "▼ " + folder.name;

        const subBox = document.createElement("div");
        subBox.style.display = "none";

        btn.onclick = ()=>{
            subBox.style.display =
                subBox.style.display === "none" ? "block" : "none";
        };

        div.appendChild(btn);
        div.appendChild(subBox);
        container.appendChild(div);

        loadSubFolder(folder.name, subBox);
    });
}

async function loadSubFolder(folder, container){
    const res = await fetch(`${baseAPI}/${encodeURIComponent(folder)}`);
    const subs = await res.json();

    subs.forEach(sub=>{
        if(sub.type !== "dir") return;

        const div = document.createElement("div");
        div.className = "sub";

        const check = document.createElement("input");
        check.type = "checkbox";

        check.onchange = ()=>{
            toggleLayer(folder, sub.name, check.checked);
        };

        const label = document.createElement("label");
        label.textContent = " " + sub.name;

        div.appendChild(check);
        div.appendChild(label);
        container.appendChild(div);
    });
}

async function toggleLayer(folder, subfolder, status){
    const key = `${folder}_${subfolder}`;

    if(status){
        const group = L.layerGroup().addTo(map);
        layers[key] = group;

        const res = await fetch(`${baseAPI}/${folder}/${subfolder}`);
        const files = await res.json();

        files.forEach(file=>{
            if(file.name.endsWith(".zip")){
                const lat = -8 + Math.random()*12;
                const lng = 108 + Math.random()*14;

                const marker = L.circleMarker([lat,lng],{
                    radius:6,
                    color:"#00ffff",
                    fillOpacity:0.8
                }).bindPopup(`
                    <b>${folder}</b><br>
                    ${subfolder}<br>
                    <a href="${file.download_url}" target="_blank">
                    Download ZIP
                    </a>
                `);

                group.addLayer(marker);
            }
        });

        if(group.getLayers().length > 0){
            map.fitBounds(group.getBounds(), {padding:[50,50]});
        }

    } else {
        if(layers[key]){
            map.removeLayer(layers[key]);
        }
    }
}

buildSidebar();
</script>

</body>
</html>
