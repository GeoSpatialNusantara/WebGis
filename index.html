<script>

// ===============================
// 4️⃣ LOAD SUBFOLDER DALAM /file
// ===============================

var folderAPI = "https://api.github.com/repos/GeoSpatialNusantara/WebGis/contents/file";
var activeLayers = {};

fetch(folderAPI)
.then(res => {
    if (!res.ok) throw new Error("Folder /file tidak ditemukan");
    return res.json();
})
.then(folders => {

    let container = document.getElementById("folderList");
    container.innerHTML = "";

    folders.forEach(folder => {

        // hanya tampilkan folder
        if (folder.type === "dir") {

            // tampilkan nama folder utama (tanpa checkbox)
            let title = document.createElement("div");
            title.style.fontWeight = "bold";
            title.style.marginTop = "10px";
            title.textContent = folder.name;
            container.appendChild(title);

            // ambil isi folder utama (subfolder)
            fetch(folder.url)
            .then(r => r.json())
            .then(subfolders => {

                subfolders.forEach(sub => {

                    if (sub.type === "dir") {

                        let div = document.createElement("div");
                        div.style.marginLeft = "15px";

                        let checkbox = document.createElement("input");
                        checkbox.type = "checkbox";

                        checkbox.onchange = function() {

                            if (this.checked) {

                                fetch(sub.url)
                                .then(r => r.json())
                                .then(files => {

                                    files.forEach(file => {

                                        if (file.name.endsWith(".geojson")) {

                                            fetch(file.download_url)
                                            .then(r => r.json())
                                            .then(data => {

                                                var geo = L.geoJSON(data, {
                                                    onEachFeature: function(feature, layer) {
                                                        if (feature.properties) {
                                                            layer.bindPopup(
                                                                Object.entries(feature.properties)
                                                                .map(([k,v]) => k + ": " + v)
                                                                .join("<br>")
                                                            );
                                                        }
                                                    }
                                                }).addTo(map);

                                                if (!activeLayers[sub.path]) {
                                                    activeLayers[sub.path] = [];
                                                }

                                                activeLayers[sub.path].push(geo);

                                            });

                                        }

                                    });

                                });

                            } else {

                                if (activeLayers[sub.path]) {
                                    activeLayers[sub.path].forEach(layer => {
                                        map.removeLayer(layer);
                                    });
                                    delete activeLayers[sub.path];
                                }

                            }

                        };

                        div.appendChild(checkbox);
                        div.appendChild(
                            document.createTextNode(" " + sub.name)
                        );

                        container.appendChild(div);

                    }

                });

            });

        }

    });

})
.catch(err => {
    document.getElementById("folderList").textContent =
        "Folder /file tidak ditemukan atau kosong.";
});

</script>
