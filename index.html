<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>WebGIS SHP - GeoSpatialNusantara</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body{
    margin:0;
    font-family:Arial, sans-serif;
    overflow:hidden;
}

#map{
    height:100vh;
    width:100%;
}

#sidebar{
    position:absolute;
    top:0;
    right:0;
    width:350px;
    height:100vh;
    background:#f4f4f4;
    border-left:1px solid #ccc;
    padding:15px;
    box-sizing:border-box;
    overflow:auto;
    transform:translateX(100%);
    transition:0.3s;
    z-index:1000;
}

#sidebar.active{
    transform:translateX(0);
}

#toggleBtn{
    position:absolute;
    top:15px;
    right:15px;
    z-index:1100;
    background:white;
    border:none;
    padding:8px 12px;
    font-size:18px;
    cursor:pointer;
    border-radius:6px;
    box-shadow:0 2px 6px rgba(0,0,0,0.2);
}

.category{
    margin-top:15px;
    font-weight:bold;
}

.year{
    margin-left:10px;
    margin-top:8px;
    font-weight:bold;
    color:#444;
}

.file-item{
    margin-left:20px;
    margin-top:6px;
    background:white;
    padding:8px;
    border-radius:6px;
    box-shadow:0 1px 4px rgba(0,0,0,0.1);
}

.file-item button{
    margin-top:5px;
    margin-right:5px;
    padding:5px 8px;
    cursor:pointer;
    border:none;
    border-radius:4px;
    background:#2c7be5;
    color:white;
}

.leaflet-tooltip{
    background:white;
    border-radius:6px;
    padding:4px 8px;
    font-weight:bold;
    border:1px solid #ccc;
}
</style>
</head>

<body>

<div id="map"></div>
<button id="toggleBtn">â˜°</button>

<div id="sidebar">
    <h2>Data SHP</h2>
    <div id="loading">Memuat struktur folder...</div>
    <div id="fileList"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>

<script>

// ===== CONFIG BARU =====
const OWNER = "GeoSpatialNusantara";
const REPO = "WebGis";
const ROOT_FOLDER = "shp";   // ubah jika beda
const BRANCH = "main";
const markerImage = "./img/point-of-interest.png";

let layerStore = {};
let centerMarkers = {};
let globalBounds = null;

// ===== MAP =====
const map = L.map('map',{minZoom:5,maxZoom:18})
.setView([-2.5,118],5);

L.tileLayer(
'https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',
{ subdomains:['mt0','mt1','mt2','mt3'] }
).addTo(map);

document.getElementById("toggleBtn")
.addEventListener("click",()=>{
    document.getElementById("sidebar")
    .classList.toggle("active");
});

function createIcon(size){
    return L.icon({
        iconUrl:markerImage,
        iconSize:[size,size],
        iconAnchor:[size/2,size]
    });
}

async function fetchGitHub(path){
    const url=`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}?ref=${BRANCH}`;
    const res=await fetch(url);
    return await res.json();
}

// ===== LOAD STRUKTUR BARU =====
async function loadFiles(){

    const container=document.getElementById("fileList");

    try{

        const categories = await fetchGitHub(ROOT_FOLDER);

        for(const cat of categories){

            if(cat.type!=="dir") continue;

            const catDiv=document.createElement("div");
            catDiv.className="category";
            catDiv.textContent=cat.name;
            container.appendChild(catDiv);

            const years = await fetchGitHub(cat.path);

            for(const year of years){

                if(year.type!=="dir") continue;

                const yearDiv=document.createElement("div");
                yearDiv.className="year";
                yearDiv.textContent=year.name;
                container.appendChild(yearDiv);

                const files = await fetchGitHub(year.path);

                for(const file of files){

                    if(!file.name.endsWith(".zip")) continue;

                    const displayName=file.name.replace(".zip","");
                    const url=file.download_url;

                    const div=document.createElement("div");
                    div.className="file-item";
                    div.innerHTML=`
                        ${displayName}<br>
                        <button onclick="viewLayer('${file.path}')">View</button>
                        <button onclick="window.open('${url}','_blank')">Download</button>
                    `;
                    container.appendChild(div);

                    await loadLayer(file.path,url,displayName);
                }
            }
        }

    }catch(err){
        console.error(err);
    }

    document.getElementById("loading").style.display="none";
}

async function loadLayer(key,url,name){

    const res=await fetch(url);
    const arrayBuffer=await res.arrayBuffer();
    const data=await shp(arrayBuffer);

    const layer=L.geoJSON(data).addTo(map);
    layerStore[key]=layer;

    if(!globalBounds){
        globalBounds=layer.getBounds();
    }else{
        globalBounds.extend(layer.getBounds());
    }

    const center=layer.getBounds().getCenter();
    const size=Math.max(40,map.getZoom()*2);

    const marker=L.marker(center,{icon:createIcon(size)}).addTo(map);

    marker.bindTooltip(name,{direction:"top"});

    marker.on("mouseover",()=>{
        marker.setIcon(createIcon(size*1.5));
        marker.openTooltip();
    });

    marker.on("mouseout",()=>{
        marker.setIcon(createIcon(size));
        marker.closeTooltip();
    });

    marker.on("click",()=>{
        map.fitBounds(layer.getBounds());
    });

    centerMarkers[key]=marker;
}

function viewLayer(key){
    if(layerStore[key]){
        map.fitBounds(layerStore[key].getBounds());
    }
}

loadFiles();

</script>
</body>
</html>
