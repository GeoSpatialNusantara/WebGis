<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>WebGIS - GeoSpatialNusantara</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body{margin:0;font-family:Arial}
#map{height:100vh;width:100%}

#sidebar{
position:fixed;
top:0;
right:0;
width:370px;
height:100%;
background:#f4f4f4;
box-shadow:-3px 0 10px rgba(0,0,0,.2);
transform:translateX(100%);
transition:.3s;
z-index:1000;
overflow:auto;
}
#sidebar.active{transform:translateX(0)}

#toggleBtn{
position:fixed;
top:15px;
right:15px;
z-index:2000;
padding:8px 12px;
border:none;
border-radius:6px;
background:white;
cursor:pointer;
box-shadow:0 2px 6px rgba(0,0,0,.2);
transition:right .3s ease;
}

.tabs{display:flex;background:#e0e0e0}
.tab{flex:1;padding:10px;text-align:center;cursor:pointer;font-weight:bold}
.tab.active{background:white;border-bottom:3px solid #2c7be5}
.tab-content{display:none;padding:15px}
.tab-content.active{display:block}

.row{display:flex;align-items:center;margin-top:8px}
.arrow{margin-right:6px;cursor:pointer;transition:.3s}
.arrow.rotate{transform:rotate(90deg)}

.toggle{
width:16px;height:16px;border-radius:50%;
background:#bbb;margin-right:8px;cursor:pointer;
transition:.2s;
}
.toggle.active{background:#2c7be5}

.year-container{display:none;margin-left:20px}

input{
width:100%;padding:8px;margin-bottom:10px;
border-radius:6px;border:1px solid #ccc;
}
</style>
</head>

<body>

<div id="map"></div>
<button id="toggleBtn">â˜°</button>

<div id="sidebar">
<div class="tabs">
<div class="tab active" data-tab="layerTab">Layer</div>
<div class="tab" data-tab="uploadTab">Upload</div>
</div>

<div id="layerTab" class="tab-content active">
<div id="layerList"></div>
</div>

<div id="uploadTab" class="tab-content">
<input type="file" id="uploadInput" multiple accept=".zip,.kml,.kmz">
<hr>
<div id="uploadList"></div>
</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>
<script src="https://unpkg.com/leaflet-omnivore@latest/leaflet-omnivore.min.js"></script>

<script>
const OWNER="GeoSpatialNusantara";
const REPO="WebGis";
const BRANCH="main";
const ROOT="file";
const markerImage="./img/point-of-interest.png";

const map=L.map('map').setView([-2.5,118],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let layerStore={};
let colorStore={};

function getCategoryFromPath(path){
return path.split("/")[1];
}

function getCategoryColor(category){
if(!colorStore[category]){
const hue=Math.floor(Math.random()*360);
colorStore[category]=`hsl(${hue},70%,50%)`;
}
return colorStore[category];
}

function buildPopupContent(properties,downloadUrl){
let html="<div style='font-size:13px'>";
if(properties){
for(let key in properties){
if(properties[key]!==null && properties[key]!==""){
html+=`<b>${key}</b>: ${properties[key]}<br>`;
}
}
}
if(downloadUrl){
html+=`<hr>
<a href="${downloadUrl}" target="_blank"
style="display:inline-block;padding:5px 8px;
background:#2c7be5;color:white;
text-decoration:none;border-radius:4px">
Download File</a>`;
}
html+="</div>";
return html;
}

function createCenterMarker(key,layer){

if(!layer.getBounds().isValid()) return;

const center=layer.getBounds().getCenter();
const size=map.getZoom()*2;

const icon=L.icon({
iconUrl:markerImage,
iconSize:[size,size],
iconAnchor:[size/2,size]
});

if(layerStore[key].marker){
map.removeLayer(layerStore[key].marker);
}

const marker=L.marker(center,{icon}).addTo(map);

marker.bindPopup(`
<b>${key.split("/").pop()}</b><br><br>
<a href="${layerStore[key].url}" target="_blank"
style="display:inline-block;padding:5px 8px;
background:#28a745;color:white;
text-decoration:none;border-radius:4px">
Download File</a>
`);

layerStore[key].marker=marker;
}

map.on("zoomend",()=>{
const size=map.getZoom()*2;
for(let key in layerStore){
if(layerStore[key].marker){
const icon=L.icon({
iconUrl:markerImage,
iconSize:[size,size],
iconAnchor:[size/2,size]
});
layerStore[key].marker.setIcon(icon);
}
}
});

async function fetchGitHub(path){
const url=`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}?ref=${BRANCH}`;
const res=await fetch(url);
return await res.json();
}

async function loadLayer(key){

if(layerStore[key].layer){
map.addLayer(layerStore[key].layer);
if(layerStore[key].marker) map.addLayer(layerStore[key].marker);
map.fitBounds(layerStore[key].layer.getBounds());
return;
}

let layer;

if(layerStore[key].url.endsWith(".zip")){

const res=await fetch(layerStore[key].url);
const buffer=await res.arrayBuffer();
const geoData=await shp(buffer);

const category=getCategoryFromPath(key);
const color=getCategoryColor(category);

layer=L.geoJSON(geoData,{
style:{color:color,weight:2,fillOpacity:0.3},
onEachFeature:function(feature,layerFeature){
layerFeature.bindPopup(
buildPopupContent(feature.properties,layerStore[key].url)
);
}
}).addTo(map);

}else{

layer=omnivore.kml(layerStore[key].url)
.on("ready",function(){
createCenterMarker(key,layer);
map.fitBounds(layer.getBounds());
})
.addTo(map);
}

layerStore[key].layer=layer;
createCenterMarker(key,layer);
map.fitBounds(layer.getBounds());
}

</script>
</body>
</html>
