<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>WebGIS Kategori Tahun</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>
<script src="https://unpkg.com/leaflet-omnivore@latest/leaflet-omnivore.min.js"></script>

<style>
body {margin:0;font-family:Arial;}
#map {height:100vh;width:100%;}

#sidebar{
 position:absolute;left:0;top:0;
 width:340px;height:100%;
 background:#fff;
 overflow:auto;
 padding:15px;
 z-index:1000;
 transform:translateX(-100%);
 transition:0.3s;
 box-shadow:2px 0 10px rgba(0,0,0,0.3);
}

#sidebar.active{transform:translateX(0);}

#toggleBtn{
 position:absolute;
 top:15px;left:15px;
 background:white;
 padding:8px 12px;
 cursor:pointer;
 z-index:1100;
 border-radius:6px;
 box-shadow:0 0 6px rgba(0,0,0,0.3);
}

.folder-title{
 cursor:pointer;
 font-weight:bold;
 background:#f1f1f1;
 padding:6px;
 margin-top:8px;
 border-radius:4px;
}

.sub-folder{ margin-left:12px; display:none; }

.file-item{
 margin-left:18px;
 margin-top:5px;
 padding:5px;
 background:#fafafa;
 border-radius:4px;
}

button{margin-top:3px;padding:4px 6px;}

#loading{
 position:absolute;
 top:50%;left:50%;
 transform:translate(-50%,-50%);
 background:white;
 padding:15px 20px;
 border-radius:8px;
 display:none;
 z-index:2000;
 box-shadow:0 0 10px rgba(0,0,0,0.3);
}

select{width:100%;margin-bottom:10px;padding:5px;}
</style>
</head>
<body>

<div id="toggleBtn">â˜°</div>

<div id="sidebar">
<h3>Basemap</h3>
<select id="basemapSelect">
<option value="osm">OpenStreetMap</option>
<option value="sat">Satellite</option>
<option value="dark">Dark</option>
</select>
<hr>
<h3>Data</h3>
<div id="container"></div>
</div>

<div id="map"></div>
<div id="loading">Loading...</div>

<script>

const username = "GeoSpatialNusantara";
const repo = "WebGis";
const rootFolder = "file";

const map = L.map('map').setView([-2.5,118],5);

let baseLayers={
 osm:L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
 sat:L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{subdomains:['mt0','mt1','mt2','mt3']}),
 dark:L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png')
};

baseLayers.osm.addTo(map);

document.getElementById("basemapSelect").onchange=function(){
 Object.values(baseLayers).forEach(l=>map.removeLayer(l));
 baseLayers[this.value].addTo(map);
};

document.getElementById("toggleBtn").onclick=()=>{
 document.getElementById("sidebar").classList.toggle("active");
};

let layers={};

async function loadStructure(){

 document.getElementById("loading").style.display="block";

 const rootAPI=`https://api.github.com/repos/${username}/${repo}/contents/${rootFolder}`;
 const categories=await (await fetch(rootAPI)).json();

 const container=document.getElementById("container");

 for(const cat of categories){

  if(cat.type==="dir"){

   const catDiv=document.createElement("div");
   catDiv.className="folder-title";
   catDiv.innerText=cat.name;

   const yearContainer=document.createElement("div");
   yearContainer.className="sub-folder";

   catDiv.onclick=()=>{
    yearContainer.style.display=
     yearContainer.style.display==="block"?"none":"block";
   };

   const years=await (await fetch(cat.url)).json();

   for(const year of years){

    if(year.type==="dir"){

     const yearDiv=document.createElement("div");
     yearDiv.className="folder-title";
     yearDiv.style.marginLeft="12px";
     yearDiv.innerText=year.name;

     const fileContainer=document.createElement("div");
     fileContainer.className="sub-folder";

     yearDiv.onclick=()=>{
      fileContainer.style.display=
       fileContainer.style.display==="block"?"none":"block";
     };

     const files=await (await fetch(year.url)).json();

     files.forEach(file=>{
      if(file.name.endsWith(".zip") ||
         file.name.endsWith(".kml") ||
         file.name.endsWith(".kmz")){

       const fileDiv=document.createElement("div");
       fileDiv.className="file-item";

       fileDiv.innerHTML=`
        ${file.name}<br>
        <button onclick="showLayer('${file.download_url}','${file.name}')">Tampilkan</button>
        <button onclick="zoomLayer('${file.name}')">Zoom</button>
        <a href="${file.download_url}" target="_blank">
         <button>Download</button>
        </a>
       `;

       fileContainer.appendChild(fileDiv);
      }
     });

     yearContainer.appendChild(yearDiv);
     yearContainer.appendChild(fileContainer);
    }
   }

   container.appendChild(catDiv);
   container.appendChild(yearContainer);
  }
 }

 document.getElementById("loading").style.display="none";
}

async function showLayer(url,name){

 document.getElementById("loading").style.display="block";

 if(layers[name]) map.removeLayer(layers[name]);

 let layer;

 if(name.endsWith(".zip")){
  const geojson=await shp(url);
  layer=L.geoJSON(geojson,{style:{color:"#0077ff"}});
 }else{
  layer=omnivore.kml(url);
 }

 layer.addTo(map);
 layers[name]=layer;

 layer.on("ready",()=>{
  map.fitBounds(layer.getBounds());
  document.getElementById("loading").style.display="none";
 });

 if(name.endsWith(".zip")){
  map.fitBounds(layer.getBounds());
  document.getElementById("loading").style.display="none";
 }
}

function zoomLayer(name){
 if(layers[name]){
  map.fitBounds(layers[name].getBounds());
 }
}

loadStructure();

</script>
</body>
</html>
