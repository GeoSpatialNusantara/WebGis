<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>WebGIS - Struktur Repository</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<style>
body {
    margin: 0;
    display: flex;
    font-family: Arial, sans-serif;
}

#sidebar {
    width: 280px;
    background: #f4f4f4;
    padding: 10px;
    overflow-y: auto;
    border-right: 1px solid #ccc;
}

#map {
    flex: 1;
    height: 100vh;
}

.folder-title {
    font-weight: bold;
    margin-top: 10px;
}

.subfolder {
    margin-left: 15px;
}

.year {
    margin-left: 30px;
}
</style>
</head>

<body>

<div id="sidebar">
    <h3>Struktur Data</h3>
    <div id="folderList">Loading...</div>
</div>

<div id="map"></div>

<script>

// ===============================
// 1. BATAS INDONESIA
// ===============================
var indonesiaBounds = [
    [-11.5, 94.5],
    [6.5, 141.5]
];

var map = L.map("map", {
    maxBounds: indonesiaBounds,
    maxBoundsViscosity: 1.0,
    minZoom: 5,
    maxZoom: 18
}).fitBounds(indonesiaBounds);

// ===============================
// 2. BASEMAP
// ===============================
var osm = L.tileLayer(
    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    { attribution: "Â© OpenStreetMap" }
).addTo(map);

var satellite = L.tileLayer(
    "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
    { attribution: "Satellite" }
);

L.control.layers({
    "OpenStreetMap": osm,
    "Satellite": satellite
}).addTo(map);

// ===============================
// 3. SEARCH
// ===============================
L.Control.geocoder().addTo(map);

// ===============================
// 4. LOAD STRUKTUR REPOSITORY
// ===============================
var baseAPI = "https://api.github.com/repos/GeoSpatialNusantara/WebGis/contents/file";
var activeLayers = {};
var container = document.getElementById("folderList");

fetch(baseAPI)
.then(res => res.json())
.then(function(mainFolders) {

    container.innerHTML = "";

    mainFolders.forEach(function(main) {

        if (main.type === "dir") {

            // Folder Utama (file)
            var title = document.createElement("div");
            title.className = "folder-title";
            title.textContent = main.name;
            container.appendChild(title);

            fetch(main.url)
            .then(res => res.json())
            .then(function(subfolders) {

                subfolders.forEach(function(sub) {

                    if (sub.type === "dir") {

                        // Subfolder (contoh: Batimetri MBES)
                        var subDiv = document.createElement("div");
                        subDiv.className = "subfolder";
                        subDiv.textContent = "ðŸ“ " + sub.name;
                        container.appendChild(subDiv);

                        fetch(sub.url)
                        .then(res => res.json())
                        .then(function(yearFolders) {

                            yearFolders.forEach(function(year) {

                                if (year.type === "dir") {

                                    var yearDiv = document.createElement("div");
                                    yearDiv.className = "year";

                                    var checkbox = document.createElement("input");
                                    checkbox.type = "checkbox";

                                    checkbox.addEventListener("change", function() {

                                        if (this.checked) {

                                            fetch(year.url)
                                            .then(res => res.json())
                                            .then(function(files) {

                                                files.forEach(function(file) {

                                                    if (file.name.endsWith(".geojson")) {

                                                        fetch(file.download_url)
                                                        .then(res => res.json())
                                                        .then(function(data) {

                                                            var layer = L.geoJSON(data).addTo(map);

                                                            if (!activeLayers[year.path]) {
                                                                activeLayers[year.path] = [];
                                                            }

                                                            activeLayers[year.path].push(layer);

                                                            map.fitBounds(layer.getBounds());

                                                        });

                                                    }

                                                });

                                            });

                                        } else {

                                            if (activeLayers[year.path]) {
                                                activeLayers[year.path].forEach(function(layer) {
                                                    map.removeLayer(layer);
                                                });
                                                delete activeLayers[year.path];
                                            }

                                        }

                                    });

                                    yearDiv.appendChild(checkbox);
                                    yearDiv.appendChild(
                                        document.createTextNode(" " + year.name)
                                    );

                                    container.appendChild(yearDiv);

                                }

                            });

                        });

                    }

                });

            });

        }

    });

})
.catch(function(error) {
    container.innerHTML = "Struktur folder tidak ditemukan.";
});

</script>

</body>
</html>
