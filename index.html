<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>WebGIS - GeoSpatialNusantara</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body{margin:0;font-family:Arial, sans-serif;overflow:hidden;}
#map{height:100vh;width:100%;}

/* Sidebar */
#sidebar{
    position:absolute;
    top:0;
    right:0;
    width:360px;
    height:100vh;
    background:#f4f4f4;
    box-shadow:-3px 0 8px rgba(0,0,0,0.2);
    padding:15px;
    box-sizing:border-box;
    overflow:auto;
    transform:translateX(100%);
    transition:0.3s;
    z-index:1000;
}
#sidebar.active{transform:translateX(0);}

#toggleBtn{
    position:absolute;
    top:15px; right:15px;
    background:white;
    padding:8px 12px;
    border:none;
    font-size:18px;
    border-radius:6px;
    cursor:pointer;
    box-shadow:0 2px 6px rgba(0,0,0,0.2);
    z-index:1100;
}

/* Styling categories/tahun */
.category{
    font-weight:bold;
    margin-top:10px;
    cursor:pointer;
    padding:5px;
    background:#e1e1e1;
    border-radius:4px;
}
.year{
    margin-left:15px;
    margin-top:8px;
    display:flex;
    align-items:center;
    cursor:pointer;
}

/* Toggle switch circle */
.toggle{
    width:14px;
    height:14px;
    border-radius:50%;
    border:2px solid #2c7be5;
    margin-right:8px;
    cursor:pointer;
    transition:0.2s;
}
.toggle.active{
    background:#2c7be5;
}
</style>

</head>
<body>

<div id="map"></div>
<button id="toggleBtn">â˜°</button>

<div id="sidebar">
    <h2>Layer Control</h2>
    <div id="layerList">Loading...</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>
<script src="https://unpkg.com/leaflet-omnivore@latest/leaflet-omnivore.min.js"></script>

<script>
// ===== SETTINGS =====
const OWNER = "GeoSpatialNusantara";
const REPO = "WebGis";
const BRANCH = "main";
const ROOT_FOLDER = "file";

// ===== INIT MAP =====
const map = L.map('map',{minZoom:5, maxZoom:18})
.setView([-2.5,118],5);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
.addTo(map);

// ===== LAYER STORAGE =====
let layerStore = {};
let markerStore = {};

// ===== SIDEBAR TOGGLE =====
document.getElementById("toggleBtn")
.addEventListener("click",()=>{
    document.getElementById("sidebar")
    .classList.toggle("active");
});

// ===== FETCH GITHUB UTILS =====
async function fetchGitHub(path){
    const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}?ref=${BRANCH}`;
    const res = await fetch(url);
    return await res.json();
}

// ===== BUILD STRUCTURE =====
async function loadStructure(){
    const container = document.getElementById("layerList");
    container.innerHTML="";

    // Ambil kategori
    const categories = await fetchGitHub(ROOT_FOLDER);

    for(const cat of categories){
        if(cat.type !== "dir") continue;

        const catDiv = document.createElement("div");
        catDiv.className = "category";
        catDiv.innerText = cat.name;
        container.appendChild(catDiv);

        const yearContainer = document.createElement("div");
        yearContainer.style.display="none";
        container.appendChild(yearContainer);

        catDiv.onclick = () => {
            yearContainer.style.display =
              yearContainer.style.display==="none" ? "block" : "none";
        };

        // Ambil tahun di kategori
        const years = await fetchGitHub(cat.path);

        for(const year of years){
            if(year.type !== "dir") continue;

            const yearRow = document.createElement("div");
            yearRow.className = "year";

            const toggle = document.createElement("div");
            toggle.className = "toggle active";

            const label = document.createElement("span");
            label.innerText = year.name;

            yearRow.appendChild(toggle);
            yearRow.appendChild(label);
            yearContainer.appendChild(yearRow);

            // Load semua file di tahun
            const files = await fetchGitHub(year.path);

            for(const file of files){
                if(
                   !file.name.endsWith(".zip") &&
                   !file.name.endsWith(".kml") &&
                   !file.name.endsWith(".kmz")
                ) continue;

                await loadLayer(
                    file.path,
                    file.download_url,
                    file.name
                        .replace(".zip","")
                        .replace(".kml","")
                        .replace(".kmz","")
                );
            }

            // Toggle layer ON/OFF
            toggle.onclick = (e) => {
                e.stopPropagation();
                toggle.classList.toggle("active");
                const active = toggle.classList.contains("active");

                for(let key in layerStore){
                    if(key.startsWith(year.path)){
                        if(active){
                            map.addLayer(layerStore[key]);
                            map.addLayer(markerStore[key]);
                        } else {
                            map.removeLayer(layerStore[key]);
                            map.removeLayer(markerStore[key]);
                        }
                    }
                }
            };
        }
    }
}

// ===== LOAD LAYER =====
async function loadLayer(key, url, name){

    let layer;

    // SHP ZIP
    if(url.endsWith(".zip")){
        const res = await fetch(url);
        const arrayBuffer = await res.arrayBuffer();
        const data = await shp(arrayBuffer);
        layer = L.geoJSON(data);
    }

    // KML / KMZ
    else {
        layer = omnivore.kml(url);
    }

    layer.addTo(map);
    layerStore[key] = layer;

    layer.on("ready", ()=>{
        const size = Math.max(40, map.getZoom()*2);
        const center = layer.getBounds().getCenter();

        const marker = L.marker(center,{
            icon:L.icon({
                iconUrl:markerImage,
                iconSize:[size,size],
                iconAnchor:[size/2,size]
            })
        }).addTo(map);

        marker.bindTooltip(name,{direction:"top"});

        marker.on("mouseover",()=>{
            marker.setIcon(L.icon({
                iconUrl:markerImage,
                iconSize:[size*1.4,size*1.4],
                iconAnchor:[(size*1.4)/2,size*1.4]
            }));
            marker.openTooltip();
        });

        marker.on("mouseout",()=>{
            marker.setIcon(L.icon({
                iconUrl:markerImage,
                iconSize:[size,size],
                iconAnchor:[size/2,size]
            }));
            marker.closeTooltip();
        });

        marker.on("click", ()=>{
            map.fitBounds(layer.getBounds());
        });

        markerStore[key] = marker;
    });

    // For KML/KMZ, fitBounds if ready
    if(url.endsWith(".kml")||url.endsWith(".kmz")){
        layer.on("ready", ()=>{
            map.fitBounds(layer.getBounds());
        });
    }
}

// ===== UPDATE MARKER SIZE ON ZOOM =====
map.on("zoomend",()=>{
    const size = Math.max(40, map.getZoom()*2);
    for(let key in markerStore){
        markerStore[key].setIcon(L.icon({
            iconUrl:markerImage,
            iconSize:[size,size],
            iconAnchor:[size/2,size]
        }));
    }
});

loadStructure();

</script>
</body>
</html>
