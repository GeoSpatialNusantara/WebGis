<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>WebGIS Repository Folder Viewer</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<style>
#map { height: 75vh; }
#folderList { padding:10px; background:#f5f5f5; }
.file-content {
    white-space: pre-wrap;
    background:#eee;
    padding:10px;
    margin-top:10px;
    max-height:200px;
    overflow:auto;
}
</style>
</head>

<body>

<h3>Isi Folder Repository</h3>
<div id="folderList"></div>

<div id="map"></div>

<div id="fileContents" class="file-content"></div>

<script>

// ==========================
// 1️⃣ BATAS INDONESIA
// ==========================
var indonesiaBounds = [
    [-11.5, 94.5],
    [6.5, 141.5]
];

var map = L.map("map", {
    maxBounds: indonesiaBounds,
    maxBoundsViscosity: 1.0
}).fitBounds(indonesiaBounds);

// ==========================
// 2️⃣ BASEMAP
// ==========================
var osm = L.tileLayer(
    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    { attribution: "&copy; OpenStreetMap" }
).addTo(map);

var satellite = L.tileLayer(
    "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
    { attribution: "Satellite" }
);

L.control.layers({
    "OpenStreetMap": osm,
    "Satellite": satellite
}).addTo(map);

// ==========================
// 3️⃣ SEARCH
// ==========================
L.Control.geocoder().addTo(map);

// ==========================
// 4️⃣ AMBIL FOLDER SAJA
// ==========================

var activeLayers = {};

fetch("https://api.github.com/repos/GeoSpatialNusantara/WebGis/contents")
.then(res => res.json())
.then(items => {

    let container = document.getElementById("folderList");

    items.forEach(item => {

        // hanya tampilkan folder (bukan file index.html)
        if (item.type === "dir") {

            let folderTitle = document.createElement("h4");
            folderTitle.textContent = "Folder: " + item.name;
            container.appendChild(folderTitle);

            // ambil isi folder
            fetch(item.url)
            .then(r => r.json())
            .then(files => {

                files.forEach(file => {

                    let label = document.createElement("label");
                    label.style.display = "block";

                    let checkbox = document.createElement("input");
                    checkbox.type = "checkbox";

                    checkbox.onchange = function() {

                        if (this.checked) {

                            fetch(file.download_url)
                            .then(r => r.text())
                            .then(text => {

                                document.getElementById("fileContents").textContent = text;

                                // tampilkan jika geojson
                                if (file.name.endsWith(".geojson")) {

                                    var geo = L.geoJSON(JSON.parse(text), {
                                        onEachFeature: function(feature, layer){
                                            if (feature.properties){
                                                layer.bindPopup(
                                                    JSON.stringify(feature.properties)
                                                );
                                            }
                                        }
                                    }).addTo(map);

                                    activeLayers[file.name] = geo;
                                }

                            });

                        } else {

                            if (activeLayers[file.name]) {
                                map.removeLayer(activeLayers[file.name]);
                                delete activeLayers[file.name];
                            }

                            document.getElementById("fileContents").textContent = "";
                        }
                    };

                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(" " + file.name));
                    container.appendChild(label);

                });

            });

        }

    });

})
.catch(err => {
    document.getElementById("folderList").textContent =
        "Gagal memuat folder: " + err;
});

</script>

</body>
</html>
